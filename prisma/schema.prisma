generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  ANALYST
  VIEWER
}

enum DealType {
  GREENFIELD
  BROWNFIELD
}

enum ScoreStatus {
  VERIFIED
  PARTIAL
  UNKNOWN
}

model User {
  id          String       @id @default(uuid())
  email       String       @unique
  name        String
  passwordHash String
  memberships Membership[]
  analysisRuns AnalysisRun[] @relation("UserRuns")
  auditLogs   AuditLog[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Organization {
  id          String       @id @default(uuid())
  name        String
  memberships Membership[]
  funds       Fund[]
  countryPacks CountryPack[]
  auditLogs   AuditLog[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Membership {
  id              String        @id @default(uuid())
  role            Role
  user            User          @relation(fields: [userId], references: [id])
  userId          String
  organization    Organization  @relation(fields: [organizationId], references: [id])
  organizationId  String
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@unique([userId, organizationId])
}

model Fund {
  id              String    @id @default(uuid())
  name            String
  thesis          Json
  organization    Organization @relation(fields: [organizationId], references: [id])
  organizationId  String
  deals           Deal[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Deal {
  id          String   @id @default(uuid())
  name        String
  country     String
  city        String
  productType String
  type        DealType
  fund        Fund     @relation(fields: [fundId], references: [id])
  fundId      String
  documents   DealDocument[]
  analyses    AnalysisRun[]
  openaiVectorStoreId String? @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model DealDocument {
  id          String   @id @default(uuid())
  name        String
  path        String
  mimeType    String
  deal        Deal     @relation(fields: [dealId], references: [id])
  dealId      String
  openaiFileId String? @unique
  openaiStatus String  @default("pending")
  sha256       String?
  originalFileSize Int?
  originalExt  String?
  uploadedAt  DateTime @default(now())
}

model CountryPack {
  id              String   @id @default(uuid())
  name            String
  countryCode     String
  allowedDomains  String[]
  goldSources     Json
  artefacts       Json
  scoringOverrides Json?
  organization    Organization @relation(fields: [organizationId], references: [id])
  organizationId  String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([organizationId, countryCode])
}

model AnalysisRun {
  id            String    @id @default(uuid())
  deal          Deal      @relation(fields: [dealId], references: [id])
  dealId        String
  executedBy    User      @relation("UserRuns", fields: [executedById], references: [id])
  executedById  String
  evidence      Json
  scorecard     Json
  summary       String
  checklist     Json
  createdAt     DateTime  @default(now())
}

model AuditLog {
  id              String   @id @default(uuid())
  action          String
  metadata        Json
  user            User?    @relation(fields: [userId], references: [id])
  userId          String?
  organization    Organization? @relation(fields: [organizationId], references: [id])
  organizationId  String?
  createdAt       DateTime @default(now())
}
